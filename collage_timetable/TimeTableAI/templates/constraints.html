{% extends "base.html" %}

{% block title %}Constraints Management - College Timetable Generator{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="display-4">
                <i data-feather="settings" class="me-3"></i>
                Constraints Management
            </h1>
            
            <div class="d-flex gap-2">
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addConstraintModal">
                    <i data-feather="plus" class="me-2"></i>
                    Add Constraint
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Constraint Types Overview -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i data-feather="info" class="me-2"></i>
                    Constraint Types
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="constraint-type-card">
                            <h6><i data-feather="user-x" class="me-2 text-danger"></i>Teacher Unavailable</h6>
                            <p class="small text-muted">Mark specific teachers as unavailable during certain time slots</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="constraint-type-card">
                            <h6><i data-feather="home" class="me-2 text-warning"></i>Room Unavailable</h6>
                            <p class="small text-muted">Mark specific rooms as unavailable during certain time slots</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="constraint-type-card">
                            <h6><i data-feather="users" class="me-2 text-info"></i>Section Preference</h6>
                            <p class="small text-muted">Set preferences for sections (e.g., avoid certain time slots)</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="constraint-type-card">
                            <h6><i data-feather="clock" class="me-2 text-success"></i>Time Preference</h6>
                            <p class="small text-muted">Set general time preferences (e.g., avoid first/last periods)</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Active Constraints -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i data-feather="list" class="me-2"></i>
                    Active Constraints
                </h5>
            </div>
            <div class="card-body">
                {% if constraints %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Type</th>
                                <th>Details</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for constraint in constraints %}
                            <tr>
                                <td>{{ constraint.name }}</td>
                                <td>
                                    <span class="badge bg-{{ 'danger' if constraint.constraint_type == 'teacher_unavailable' else 'warning' if constraint.constraint_type == 'room_unavailable' else 'info' if constraint.constraint_type == 'section_preference' else 'success' }}">
                                        {{ constraint.constraint_type.replace('_', ' ').title() }}
                                    </span>
                                </td>
                                <td>
                                    {% if constraint.constraint_type == 'teacher_unavailable' %}
                                        <strong>{{ constraint.teacher.name }}</strong> - Day {{ constraint.day_of_week + 1 }}, Period {{ constraint.period_number }}
                                    {% elif constraint.constraint_type == 'room_unavailable' %}
                                        <strong>{{ constraint.room.number }}</strong> - Day {{ constraint.day_of_week + 1 }}, Period {{ constraint.period_number }}
                                    {% elif constraint.constraint_type == 'section_preference' %}
                                        <strong>{{ constraint.section.name }}</strong> - Day {{ constraint.day_of_week + 1 }}, Period {{ constraint.period_number }}
                                    {% elif constraint.constraint_type == 'time_preference' %}
                                        Day {{ constraint.day_of_week + 1 }}, Period {{ constraint.period_number }}
                                    {% endif %}
                                </td>
                                <td>{{ constraint.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteConstraint({{ constraint.id }})">
                                        <i data-feather="trash-2" style="width: 14px; height: 14px;"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i data-feather="settings" style="width: 48px; height: 48px;" class="text-muted mb-3"></i>
                    <h5>No Constraints Set</h5>
                    <p class="text-muted">Add constraints to customize your timetable generation.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Add Constraint Modal -->
<div class="modal fade" id="addConstraintModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Constraint</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('add_constraint') }}">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="constraint_name" class="form-label">Constraint Name</label>
                                <input type="text" class="form-control" id="constraint_name" name="name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="constraint_type" class="form-label">Constraint Type</label>
                                <select class="form-select" id="constraint_type" name="constraint_type" required onchange="updateConstraintFields()">
                                    <option value="">Select Type</option>
                                    <option value="teacher_unavailable">Teacher Unavailable</option>
                                    <option value="room_unavailable">Room Unavailable</option>
                                    <option value="section_preference">Section Preference</option>
                                    <option value="time_preference">Time Preference</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Teacher Selection (for teacher_unavailable) -->
                    <div class="row" id="teacher_field" style="display: none;">
                        <div class="col-12">
                            <div class="mb-3">
                                <label for="teacher_id" class="form-label">Select Teacher</label>
                                <select class="form-select" id="teacher_id" name="teacher_id">
                                    <option value="">Select Teacher</option>
                                    {% for teacher in teachers %}
                                    <option value="{{ teacher.id }}">{{ teacher.name }} ({{ teacher.designation }})</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Room Selection (for room_unavailable) -->
                    <div class="row" id="room_field" style="display: none;">
                        <div class="col-12">
                            <div class="mb-3">
                                <label for="room_id" class="form-label">Select Room</label>
                                <select class="form-select" id="room_id" name="room_id">
                                    <option value="">Select Room</option>
                                    {% for room in rooms %}
                                    <option value="{{ room.id }}">{{ room.number }} ({{ room.room_type }})</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Section Selection (for section_preference) -->
                    <div class="row" id="section_field" style="display: none;">
                        <div class="col-12">
                            <div class="mb-3">
                                <label for="section_id" class="form-label">Select Section</label>
                                <select class="form-select" id="section_id" name="section_id">
                                    <option value="">Select Section</option>
                                    {% for section in sections %}
                                    <option value="{{ section.id }}">{{ section.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="day_of_week" class="form-label">Day of Week</label>
                                <select class="form-select" id="day_of_week" name="day_of_week" required>
                                    <option value="">Select Day</option>
                                    <option value="0">Monday</option>
                                    <option value="1">Tuesday</option>
                                    <option value="2">Wednesday</option>
                                    <option value="3">Thursday</option>
                                    <option value="4">Friday</option>
                                    <option value="5">Saturday</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="period_number" class="form-label">Period Number</label>
                                <select class="form-select" id="period_number" name="period_number" required>
                                    <option value="">Select Period</option>
                                    <option value="1">Period 1 (09:00-09:50)</option>
                                    <option value="2">Period 2 (09:50-10:40)</option>
                                    <option value="3">Period 3 (10:40-11:30)</option>
                                    <option value="4">Period 4 (11:45-12:35)</option>
                                    <option value="5">Period 5 (12:35-13:25)</option>
                                    <option value="6">Period 6 (14:10-15:00)</option>
                                    <option value="7">Period 7 (15:00-15:50)</option>
                                    <option value="8">Period 8 (15:50-16:40)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Constraint</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
function updateConstraintFields() {
    const constraintType = document.getElementById('constraint_type').value;
    
    // Hide all fields
    document.getElementById('teacher_field').style.display = 'none';
    document.getElementById('room_field').style.display = 'none';
    document.getElementById('section_field').style.display = 'none';
    
    // Show relevant field
    if (constraintType === 'teacher_unavailable') {
        document.getElementById('teacher_field').style.display = 'block';
    } else if (constraintType === 'room_unavailable') {
        document.getElementById('room_field').style.display = 'block';
    } else if (constraintType === 'section_preference') {
        document.getElementById('section_field').style.display = 'block';
    }
}

function deleteConstraint(constraintId) {
    if (confirm('Are you sure you want to delete this constraint?')) {
        fetch(`/constraints/${constraintId}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        }).then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error deleting constraint: ' + data.error);
            }
        });
    }
}

// Initialize feather icons
document.addEventListener('DOMContentLoaded', function() {
    feather.replace();
});
</script>
{% endblock %} 